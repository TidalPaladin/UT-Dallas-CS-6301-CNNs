% ---------
%  Compile with "pdflatex hw1".
% --------
%!TEX TS-program = pdflatex
%!TEX encoding = UTF-8 Unicode

% Template borrowed from Jeff Erickson.

\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}		% Allow some non-ASCII Unicode in source
\usepackage{jeffe, handout,graphicx}
\usepackage{forest}
\usepackage{mathtools}
\usepackage{cnn}
\usepackage{subfigure}


% =========================================================
%   Define common stuff for solution headers
% =========================================================
\Class{CS 6301.503}
\Semester{Spring 2019}
\Authors{1}
\AuthorOne{Scott C. Waggener}{scw180000}
%\Section{}

% =========================================================
\begin{document}
\HomeworkHeader{6 (Design)}{1}% homework number, problem number
% ---------------------------------------------------------
Read
\begin{solution}
	Complete
\end{solution}

% =========================================================
\HomeworkHeader{6 (Design)}{2}% homework number, problem number
% ---------------------------------------------------------
Read
\begin{solution}
	Complete
\end{solution}

% =========================================================
\HomeworkHeader{6 (Design)}{3}% homework number, problem number
% ---------------------------------------------------------
Read
\begin{solution}
	Complete
\end{solution}

% =========================================================
\HomeworkHeader{6 (Design)}{4}% homework number, problem number
% ---------------------------------------------------------
Read
\begin{solution}
	Complete
\end{solution}

% =========================================================
\HomeworkHeader{6 (Design)}{5}% homework number, problem number
% ---------------------------------------------------------
Compute the receptive field size at the input to the global average pooling layer for ResNet 50.

\begin{solution}
	pass
\end{solution}
	Stride then add
\begin{proof}
	\begin{align}
		\bigg(
			\Big(
				\underbrace{1+2*3}_{\text{conv5}}
				+
				\underbrace{2*6}_{\text{conv4}}
				+
				\underbrace{2*4}_{\text{conv4}}
				+
				\underbrace{2*3}_{\text{conv4}}
			\Big)
			\underbrace{*2+2}_{\text{max pool}}
		\bigg)
		\underbrace{*2+6}_{\text{conv1}}
		\\
		=142
	\end{align}
\end{proof}

% =========================================================
\HomeworkHeader{6 (Design)}{6}% homework number, problem number
% ---------------------------------------------------------
\begin{enumerate}[(a)]
	\item How does the accuracy of the half wide version copare to the original
		version?
	\begin{solution}
		The accuracy at the final epoch for the full and half versions are
		\begin{align}
			\text{Full} &= 91.03\%
			&
			\text{Half} &= 89.31\%
		\end{align}
	\end{solution}
	\begin{proof}
	\end{proof}

	\item How long does an epoch of training take for both versions?
	\begin{solution}
		The times for epoch $3$ for both models (trained on GTX970) are
		\begin{align}
			\text{Full} &= 59s
			&
			\text{Half} &= 36s
		\end{align}
	\end{solution}
	\begin{proof}
	\end{proof}

	\item Approximate how feature map memory, filter memory, and compute change
		between the full and half width versions.
	\begin{solution}

		\begin{align}
			&\text{Feature map memory} = \frac{1}{2}
			\\
			&\text{Filter memory} = \frac{1}{2}
			\\
			&\text{Compute} = \frac{1}{4}
		\end{align}
	\end{solution}
	\begin{proof}
		As an approximation we can consider how CNN style 2D convolution layers
		will be impacted by the width reduction, as Resnet is primarily
		composed of such layers. For filter and feature map memory we will see
		a reduction approximately equal to the reduction in width. The
		dimensions of the filters and feature maps remain unchanged, but we are
		only considering half of the original feature maps and filters.
		\newline

		Recall that compute for CNN style 2D convolution depends on $N_o * N_i$
		which are both reduced by half, leading to a total reduction of $1/4$.
	\end{proof}

\end{enumerate}
% =========================================================
\HomeworkHeader{6 (Design)}{7}% homework number, problem number
% ---------------------------------------------------------
\begin{solution}
	The network design will be based on Inception v4. To inform our choice
	of network architecture we can use the given hint for an expected input
	global average pooling and think backwards from here. Obviously for
	CIFAR-10 we will have $10$ classes, so we need to choose $N_i$ to global
	average pooling somewhere above $10$, call it $50$.

\begin{figure}[H]
	\noindent\resizebox{\textwidth}{!}{
	\begin{tikzpicture}
		\tikzset{
			cnn/.style={
				fill=black!20
			},
			pool/.style={
				fill=red!50
			},
			tail/.style={
				fill=black!50
			},
			inp/.style={
				fill=blue!80
			}
		}
		\def\groupsep{0.4cm}

		% Input
		\pic[inp] (input) at (0,0,0) {
				pic conv2d={res 3 depth 0.2}
		};

		\pic[inp] (input) at (0,0,0) {
				pic cnn/dims/above={res 3 depth 0.2 to 4
				text $3\times 32\times 32$
			}
		};

		% Simple tail
		\pic[tail, right=\groupsep of input-south east] (tail)  {
			pic conv2d={res 3 depth 0.2}
		};
		\pic[tail, color=blue, right=\groupsep of input-south east] {
				pic cnn/dims/below={res 3 depth 0.2 to -2
				text tail
			}
		};

		% Inception A
		\pic[cnn, right=\groupsep+2*0.4cm of tail-south east] {
			pic cnn/dims/above={res 3 depth 0.2 to 4 text Test this}
		};
		\pic[cnn,right=\groupsep of tail-south east, pic text=Inception A] (A) {
			pic conv2d/repeat/decorate={res 3 depth 0.2 repeat 5 sep 0.2},
		};

		% Reduction A
		\pic[pool, right=\groupsep of A-south east] (A2)  {
			pic conv2d={res 2 depth 0.4}
		};
		\pic[pool, right=\groupsep of A-south east]  {
			pic cnn/dims/above={res 2 depth 0.4 to 4
				text Reduction A
			}
		};

		% Inception B
		\pic[cnn, pic text=Inception B, right=\groupsep of A2-south east]
		(B) {
			pic conv2d/repeat/decorate={res 2 depth 0.4 repeat 10 sep 0.2}
		};
		\pic[cnn, right=\groupsep+5*0.6cm of A2-south east] {
			pic cnn/dims/above={res 2 depth 0.4 to 4
				text $10 \times 17 \times 17$
			}
		};

		% Reduction B
		\pic[pool, right=\groupsep of B-south east] (B2){
			pic conv2d={res 1 depth 0.6}
		};
		\pic[pool, right=\groupsep of B-south east]   {
				pic cnn/dims/above={res 1 depth 0.6 to 4
				text Reduction B
			}
		};

		% Inception C
		\pic[cnn, right=\groupsep+2*0.8cm of B2-south east] {
			pic cnn/dims/above={res 1 depth 0.6 to 4
				text $30\times8\times8$
			}
		};
		\pic[cnn, pic text=Inception C, right=\groupsep of B2-south east] (C)  {
			pic conv2d/repeat/decorate={res 1 depth 0.6 repeat 5 sep 0.2}
		};

		% Feature vector 1
		\pic[cnn, right=\groupsep of C-south east] (D)  {
				pic vec={res 3 depth 0.25}
		};
		\pic[cnn, right=\groupsep of C-south east]  {
				pic cnn/dims/above={res 3 depth 0.25 to 4
				text $30\times1\times1$
			}
		};
		\pic[cnn, right=\groupsep of C-south east]  {
				pic cnn/dims/below={res 3 depth 0.25 to -2
				text Feature Vector
			}
		};

	\end{tikzpicture}
	}
	\caption{Example CNN.}
	\label{fig:cnn}
\end{figure}

\tikzset{
	x=2cm, y=1.5cm,
	every node/.style={
		draw,
		scale=0.8,
		align=center,
		fill=black!20,
		inner sep=0.5em
	},
	conv/.style={
		rectangle,
		fill=red!20
	},
	nonlin/.style={
		rectangle,
		fill=red!20
	},
	plus/.style={
		circle,
		fill=blue!20,
		inner sep=0.25em
	},
	line/.style={
		->,
		line width=0.4mm
	}
}

\begin{figure}[H]
	\centering
	\subfigure[Resnet A]
	{
	\begin{tikzpicture}[x=2cm, y=1.25cm]
		\tikzset{
			every node/.style={
				draw,
				scale=0.8,
				align=center,
				fill=black!20,
				inner sep=0.5em
			},
			conv/.style={
				rectangle,
				fill=red!20
			},
			nonlin/.style={
				rectangle,
				fill=red!20
			},
			plus/.style={
				circle,
				fill=blue!20,
				inner sep=0.25em
			},
			line/.style={
				->,
				line width=0.4mm
			}
		}

		\node[nonlin] (in) at (0.5, 0.5)
			{Relu};
		\node[nonlin] (out) at (0.5, 6)
			{Relu};
		\node[plus] (join) at (0.5, 5)
			{+};

		\node[conv] at (1, 3) (conv1)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (2, 2) (conv2-1)
			{$32 \times 1 \times 1$\\ conv};
		\node[conv] at (2, 3) (conv2-2)
			{$32 \times 3 \times 3$\\ conv};

		\node[conv] at (3, 2) (conv3-1)
			{$32 \times 1 \times 1$\\ conv};
		\node[conv] at (3, 3) (conv3-2)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (3, 4) (conv3-3)
			{$64 \times 3 \times 3$\\ conv};

		\node[conv] at (2, 5) (conv4)
			{$348 \times 1 \times 1$\\ conv};

		\draw[line] (in) -- (join);

		\draw[line] (in) -- (conv1);
		\draw[line] (in) -| (conv2-1);
		\draw[line] (in) -| (conv3-1);

		\draw[line] (conv2-1) -- (conv2-2);
		\draw[line] (conv3-1) -- (conv3-2);
		\draw[line] (conv3-2) -- (conv3-3);

		\draw[line] (conv1) -- (conv4);
		\draw[line] (conv2-2) -- (conv4);
		\draw[line] (conv3-3) |- (conv4);

		\draw[line] (conv4) -- (join);
		\draw[line] (join) -- (out);

	\end{tikzpicture}
	}
	\subfigure[Resnet B]
	{
	\begin{tikzpicture}[y=1.25cm]

		\node[nonlin] (in) at (0.5, 0.5)
			{Relu};
		\node[nonlin] (out) at (0.5, 6)
			{Relu};
		\node[plus] (join) at (0.5, 5)
			{+};

		\node[conv] at (1.5, 3) (conv1)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (2.5, 2) (conv2-1)
			{$32 \times 1 \times 1$\\ conv};
		\node[conv] at (2.5, 3) (conv2-2)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (2.5, 4) (conv2-3)
			{$64 \times 3 \times 3$\\ conv};

		\node[conv] at (1.5, 5) (conv4)
			{$348 \times 1 \times 1$\\ conv};

		\draw[line] (in) -- (join);

		\draw[line] (in) -- (conv1);
		\draw[line] (in) -| (conv2-1);

		\draw[line] (conv2-1) -- (conv2-2);
		\draw[line] (conv2-2) -- (conv2-3);

		\draw[line] (conv1) -- (conv4);
		\draw[line] (conv2-3) |- (conv4);

		\draw[line] (conv4) -- (join);
		\draw[line] (join) -- (out);

	\end{tikzpicture}
	}
	\label{fig:res-ab}
	\caption{Modified Inception v4 resnets A/C}
\end{figure}

\begin{figure}[H]
	\centering
		\begin{tikzpicture}[y=1.25cm]

		\node[nonlin] (in) at (0.5, 0.5)
			{Relu};
		\node[nonlin] (out) at (0.5, 6)
			{Relu};
		\node[plus] (join) at (0.5, 5)
			{+};

		\node[conv] at (1.5, 3) (conv1)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (2.5, 2) (conv2-1)
			{$32 \times 1 \times 1$\\ conv};
		\node[conv] at (2.5, 3) (conv2-2)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (2.5, 4) (conv2-3)
			{$64 \times 3 \times 3$\\ conv};

		\node[conv] at (1.5, 5) (conv4)
			{$348 \times 1 \times 1$\\ conv};

		\draw[line] (in) -- (join);

		\draw[line] (in) -- (conv1);
		\draw[line] (in) -| (conv2-1);

		\draw[line] (conv2-1) -- (conv2-2);
		\draw[line] (conv2-2) -- (conv2-3);

		\draw[line] (conv1) -- (conv4);
		\draw[line] (conv2-3) |- (conv4);

		\draw[line] (conv4) -- (join);
		\draw[line] (join) -- (out);

	\end{tikzpicture}
	\caption{Modified Inception v4 resnet C}
	\label{fig:res-c}
\end{figure}

\begin{figure}[H]
	\centering
	\subfigure[Reduction A]
	{
	\begin{tikzpicture}

		\node[nonlin] (in) at (0, 0)
			{Filter Concat};
		\node[nonlin] (out) at (0, 4)
			{Filter Concat};

		\node[conv] at (-1, 2) (conv1)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (0, 2) (conv2)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (1, 1) (conv3-1)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (1, 2) (conv3-2)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (1, 3) (conv3-3)
			{$48 \times 3 \times 3$\\ conv};

		\draw[line] (in) -| (conv1);
		\draw[line] (in) -- (conv2);
		\draw[line] (in) -- (conv3-1);

		\draw[line] (conv3-1) -- (conv3-2);
		\draw[line] (conv3-2) -- (conv3-3);

		\draw[line] (conv1) -- (out);
		\draw[line] (conv2) -- (out);
		\draw[line] (conv3-3) -- (out);
	\end{tikzpicture}
	}
	\subfigure[Reducation B]
	{
	\begin{tikzpicture}

		\node[nonlin] (in) at (0, 0)
			{Filter Concat};
		\node[nonlin] (out) at (0, 4)
			{Filter Concat};

		\node[conv] at (-1.5, 2) (conv1)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (-0.5, 1) (conv2-1)
			{$32 \times 1 \times 1$\\ conv};
		\node[conv] at (-0.5, 2) (conv2-2)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (0.5, 1) (conv3-1)
			{$32 \times 1 \times 1$\\ conv};
		\node[conv] at (0.5, 2) (conv3-2)
			{$32 \times 1 \times 1$\\ conv};

		\node[conv] at (1.5, 1) (conv4-1)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (1.5, 2) (conv4-2)
			{$48 \times 3 \times 3$\\ conv};
		\node[conv] at (1.5, 3) (conv4-3)
			{$48 \times 3 \times 3$\\ conv};

		\draw[line] (in) -| (conv1);
		\draw[line] (in) -- (conv2-1);
		\draw[line] (in) -- (conv3-1);
		\draw[line] (in) -| (conv4-1);

		\draw[line] (conv2-1) -- (conv2-2);
		\draw[line] (conv3-1) -- (conv3-2);

		\draw[line] (conv4-1) -- (conv4-2);
		\draw[line] (conv4-2) -- (conv4-3);

		\draw[line] (conv1) -- (out);
		\draw[line] (conv2-2) -- (out);
		\draw[line] (conv3-2) -- (out);
		\draw[line] (conv4-3) -- (out);

	\end{tikzpicture}
	}
	\label{fig:red}
	\caption{Modified Inception v4 reductions}
\end{figure}


\end{solution}
\begin{proof}
\end{proof}
% =========================================================
\HomeworkHeader{6 (Design)}{8}% homework number, problem number
% ---------------------------------------------------------
\begin{solution}
\end{solution}
\begin{proof}
\end{proof}
% =========================================================
\HomeworkHeader{6 (Design)}{9}% homework number, problem number
% ---------------------------------------------------------
\begin{solution}
\end{solution}
\begin{proof}
\end{proof}

\end{document}
